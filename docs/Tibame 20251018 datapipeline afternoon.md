# Data Pipeline 課堂筆記（2025/10/18 下午）

## 資料庫連線的例外處理

-   強調只要需實際連線或開啟外部資源，就必須以 `try/except` 包覆，因為錯誤無法事前以 `if` 判斷。
-   介紹 PyMySQL 內建的 `OperationalError`（帳密錯誤等用戶端問題）與 `InternalError`（伺服端異常），建議回傳自訂錯誤碼與呼叫端約定行為。
-   鼓勵針對已知風險撰寫明確的 `except <SpecificError>`，僅在最後兜底才使用廣義 `except Exception`。

------------------------------------------------------------------------

## 交易安全與資源釋放

-   在交易期間若未捕捉例外，程式掛掉會使交易卡在未完成狀態，導致資料不一致。
-   示範在 `try/except/finally` 中執行 `commit()` 或 `rollback()`，確保交易結束，同時於 `finally` 收合 cursor、connection。
-   分享處理 `IntegrityError`（PK 重複等）時的示範做法，並提醒要依商業邏輯決定忽略、刪除或重試策略。

------------------------------------------------------------------------

## ORM 與 SQLAlchemy 基礎

-   介紹 ORM 架構理念：以類別映射資料表，透過物件操作資料而非手寫 SQL。
-   使用 SQLAlchemy `declarative_base()` 建立模型，於 `__tablename__` 指定資料表名稱，欄位透過 `Column`, `String`, `Integer` 等型別定義，並設定主鍵、長度等約束。
-   透過覆寫 `__repr__` 自訂物件印出格式，有助於除錯時閱讀。

------------------------------------------------------------------------

## Engine 與連線 URI 設定

-   透過 `create_engine("mysql+pymysql://user:pass@host:port/db")` 建立連線，說明 URI 各段落意義與常見填寫錯誤。
-   當帳密含有 `@`、`:` 等特殊字元時，可用 `urllib.parse.quote_plus` 編碼，避免 URI 解析失敗。
-   強調底層仍是 PyMySQL 進行連線，故例外處理與交易觀念與前段一致。

------------------------------------------------------------------------

## Pandas 與資料庫整合

-   示範建立 Engine 後，使用 `pd.read_sql(sql, con=engine)` 直接讀取資料表，無需手動撰寫連線流程。
-   建議將 SQL 字串與 Engine 變數切開管理，並保留在 Notebook 中方便調整。
-   提醒執行失敗時先檢查資料庫名稱與大小寫，再確認帳密是否已正確編碼。
